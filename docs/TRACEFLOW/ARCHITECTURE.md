# TRACEFLOW System Architecture

> **Last Updated:** 2025-12-10  
> **Version:** 2.0.0-enterprise  
> **Classification:** Enterprise-Grade DXI Platform

---

## Executive Summary

TRACEFLOW is an enterprise-grade Digital Experience Intelligence (DXI) platform designed for:
- **BFSI/Insurance/Government** deployments with strict compliance requirements
- **Hybrid/On-Prem** operation with zero PII leaving enterprise boundaries
- **AI-Native** analysis with multi-LLM orchestration via NeuroRouter
- **Temporal-Durable** workflows for reliable multi-step AI pipelines
- **Real-time** live replay via WebRTC for support and fraud investigation

---

## High-Level Architecture (Enterprise-Grade)

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                                  CLIENT LAYER                                         │
├──────────────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │   Web SDK    │  │  Mobile SDK  │  │  Backend SDK │  │   REST API   │              │
│  │  (rrweb +    │  │  (RN/Flutter)│  │  (Node/Py/Go)│  │   Clients    │              │
│  │  Custom)     │  │              │  │              │  │              │              │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │
│         │                 │                 │                 │                      │
│         │    ┌────────────┴─────────────────┴─────────────────┘                      │
│         │    │                                                                        │
│         ▼    ▼                                                                        │
│  ┌──────────────────────────────────────────────────────────────────────────────┐    │
│  │                        STREAMING PROTOCOLS                                    │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │    │
│  │  │   WebRTC    │  │  WebSocket  │  │    HTTPS    │  │   gRPC      │          │    │
│  │  │ (Live View) │  │  (Realtime) │  │   (Batch)   │  │  (Backend)  │          │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘          │    │
│  └──────────────────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                              RUNNER LAYER (On-Prem/Hybrid)                            │
│                         [ENTERPRISE-CRITICAL: BFSI/Insurance/Govt]                    │
├──────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                         RUNNER RUNTIME (Docker/K8s/VM)                          │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  Ingest     │  │ Tokenization│  │  Local      │  │  Offline    │            │ │
│  │  │  Server     │  │   Engine    │  │  Redis      │  │   Mode      │            │ │
│  │  │  (Go/Node)  │  │ (PII Redact)│  │  Streams    │  │  Buffer     │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│  ┌─────────────────────────────────────┼───────────────────────────────────────────┐ │
│  │                         RUNNER CAPABILITIES                                      │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  High-      │  │  Zero PII   │  │  Policy     │  │  Ingest     │            │ │
│  │  │  Throughput │  │  Leaves     │  │  Sync       │  │  Protection │            │ │
│  │  │  Ingestion  │  │  Enterprise │  │  (Cloud→Run)│  │  (mTLS)     │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  Local      │  │  Compression│  │  Chunking   │  │  Retry &    │            │ │
│  │  │  Workers    │  │  Engine     │  │  Service    │  │  DLQ        │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│                                        ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                    POLICY SYNC (Cloud → Runner)                                  │ │
│  │  • Feature flags              • Retention policies                               │ │
│  │  • Sampling rules             • Rate limits per tenant                           │ │
│  │  • PII masking patterns       • Compliance settings (GDPR/HIPAA)                 │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                        TRAFFIC CONTROL & SAMPLING LAYER                               │
├──────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                         ADAPTIVE SAMPLING ENGINE                                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  Adaptive   │  │  Rate       │  │  Per-Tenant │  │  Backpressure│            │ │
│  │  │  Sampling   │  │  Limiting   │  │  Quotas     │  │  Reactor     │            │ │
│  │  │  (Priority) │  │  (Token)    │  │  (Billing)  │  │  (Shedding)  │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│  ┌─────────────────────────────────────┼───────────────────────────────────────────┐ │
│  │                       SAMPLING STRATEGIES                                        │ │
│  │  • Priority sampling: Always capture high-frustration sessions                   │ │
│  │  • Head-based sampling: Sample decision at session start                         │ │
│  │  • Tail-based sampling: Keep interesting sessions post-analysis                  │ │
│  │  • Error-biased sampling: 100% capture on errors/crashes                         │ │
│  │  • Revenue-weighted: Higher sample rate for high-value users                     │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                              INGESTION LAYER                                          │
├──────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                    API GATEWAY (Edge Functions / Go Services)                    │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  WebRTC     │  │  WebSocket  │  │    REST     │  │   Batch     │            │ │
│  │  │  Signaling  │  │  Handler    │  │  Endpoint   │  │   Upload    │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│                                        ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                    EVENT VALIDATION & ENRICHMENT                                 │ │
│  │  • Schema validation (Zod)        • IP geolocation lookup                        │ │
│  │  • Device fingerprinting          • Session association                          │ │
│  │  • PII detection & masking        • Tenant identification                        │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                              STREAMING LAYER                                          │
├──────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                         STREAM PROCESSOR                                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │   Event     │  │  Rage Click │  │   Dead      │  │  Frustration│            │ │
│  │  │   Router    │  │  Detector   │  │   Click     │  │  Calculator │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                    REDIS STREAMS (Upstash / On-Prem Redis)                       │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  Event      │  │   AI        │  │  Priority   │  │   Dead      │            │ │
│  │  │  Stream     │  │   Queue     │  │   Queue     │  │   Letter    │            │ │
│  │  │             │  │             │  │             │  │   Queue     │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                         TEMPORAL WORKFLOW LAYER                                       │
│                      [DURABLE AI ORCHESTRATION ENGINE]                                │
├──────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                         TEMPORAL.IO CLUSTER                                      │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  Workflow   │  │  Activity   │  │  Scheduler  │  │  History    │            │ │
│  │  │  Workers    │  │  Workers    │  │  Service    │  │  Service    │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                    WORKFLOW CAPABILITIES                                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  Retry      │  │  Automatic  │  │  Multi-Step │  │  DLQ →      │            │ │
│  │  │  Policies   │  │  Recovery   │  │  AI Pipes   │  │  Retry      │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  Parallel   │  │  Multi-Agent│  │  Workflow   │  │  Long-Running│            │ │
│  │  │  Execution  │  │  Sequencing │  │  Versioning │  │  Durability │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                    WORKFLOW TYPES                                                │ │
│  │  • SessionAnalysisWorkflow      → Multi-step session intelligence                │ │
│  │  • JourneyCausalityWorkflow     → Root cause analysis pipeline                   │ │
│  │  • UXAuditWorkflow              → Component-level anomaly scan                   │ │
│  │  • BillingMeteringWorkflow      → Token usage & cost tracking                    │ │
│  │  • DLQRetryWorkflow             → Failed task recovery                           │ │
│  │  • ReportGenerationWorkflow     → Scheduled analytics exports                    │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                           INTELLIGENCE LAYER                                          │
├──────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                    NEUROROUTER (Multi-LLM Task Router)                           │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │   Gemini    │  │   OpenAI    │  │   Claude    │  │  DeepSeek   │            │ │
│  │  │   (Vision)  │  │   (Code)    │  │  (Reason)   │  │  (Economy)  │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                    CIRCUIT BREAKER & FAILOVER                                    │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  Provider   │  │  Automatic  │  │  Fallback   │  │  Cost       │            │ │
│  │  │  Health     │  │  Circuit    │  │  Chain      │  │  Optimization│            │ │
│  │  │  Monitor    │  │  Breaker    │  │  Routing    │  │  Router     │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  │                                                                                  │ │
│  │  Circuit Breaker States:                                                         │ │
│  │  • CLOSED: Normal operation, requests flow through                               │ │
│  │  • OPEN: Provider failed, route to fallback                                      │ │
│  │  • HALF-OPEN: Testing if provider recovered                                      │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                         ANALYSIS ENGINES                                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │   Session   │  │  Journey    │  │  Conversion │  │   Anomaly   │            │ │
│  │  │   Analyzer  │  │   Mapper    │  │   Funnel    │  │   Detector  │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │   UX DNA    │  │  Causality  │  │  Feature    │  │  Self-Heal  │            │ │
│  │  │   Mapper    │  │   Engine    │  │  Simulator  │  │   Suggester │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                              STORAGE LAYER                                            │
├──────────────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐                    │
│  │    PostgreSQL    │  │      Redis       │  │  Object Storage  │                    │
│  │   (Supabase)     │  │   (Upstash)      │  │  (S3/MinIO)      │                    │
│  │                  │  │                  │  │                  │                    │
│  │  • Sessions      │  │  • Session cache │  │  • Recordings    │                    │
│  │  • Events        │  │  • Rate limiting │  │  • Screenshots   │                    │
│  │  • UX Issues     │  │  • Realtime pub  │  │  • Exports       │                    │
│  │  • Analytics     │  │  • Job queues    │  │  • Backups       │                    │
│  │  • Billing data  │  │  • Circuit state │  │  • Cold archive  │                    │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘                    │
│                                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐                                          │
│  │    pgvector      │  │  Cold Storage    │                                          │
│  │   (Embeddings)   │  │  (S3 Glacier)    │                                          │
│  │                  │  │                  │                                          │
│  │  • Semantic      │  │  • 6-12 month    │                                          │
│  │    search        │  │    old replays   │                                          │
│  │  • Clustering    │  │  • Compliance    │                                          │
│  │  • Similarity    │  │    archives      │                                          │
│  └──────────────────┘  └──────────────────┘                                          │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                       BILLING & TOKEN METERING LAYER                                  │
├──────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                         USAGE METERING                                           │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  Session    │  │  AI Token   │  │  Storage    │  │  API Call   │            │ │
│  │  │  Counter    │  │  Tracker    │  │  Meter      │  │  Counter    │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                         BILLING INTEGRATION                                      │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  Stripe     │  │  Invoice    │  │  Usage      │  │  Quota      │            │ │
│  │  │  Integration│  │  Generator  │  │  Alerts     │  │  Enforcement│            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  │                                                                                  │ │
│  │  Metering Dimensions:                                                            │ │
│  │  • Sessions captured per month           • AI tokens consumed                    │ │
│  │  • Storage GB used                       • API calls per minute                  │ │
│  │  • Unique visitors tracked               • Real-time connections                 │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                       OBSERVABILITY LAYER (OpenTelemetry)                             │
├──────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                    DISTRIBUTED TRACING                                           │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  Jaeger     │  │  Prometheus │  │  Grafana    │  │  Loki       │            │ │
│  │  │  (Traces)   │  │  (Metrics)  │  │  (Dashboards│  │  (Logs)     │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                         ALERTING & INCIDENTS                                     │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │ │
│  │  │  PagerDuty  │  │  Slack      │  │  Email      │  │  Webhook    │            │ │
│  │  │  Integration│  │  Alerts     │  │  Alerts     │  │  Triggers   │            │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                          PRESENTATION LAYER                                           │
├──────────────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐                    │
│  │    Dashboard     │  │    REST API      │  │    Webhooks      │                    │
│  │    (React SPA)   │  │    (External)    │  │    (Outbound)    │                    │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘                    │
└──────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow Architecture

### Event Capture Flow (Enterprise)

```
┌─────────┐     ┌─────────┐     ┌─────────────────────────────────────────┐
│  User   │────▶│   SDK   │────▶│              RUNNER                     │
│ Action  │     │ Capture │     │  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
└─────────┘     └─────────┘     │  │ Ingest  │─▶│Tokenize │─▶│ Local   │ │
                    │           │  │ Server  │  │ (PII)   │  │ Redis   │ │
                    │           │  └─────────┘  └─────────┘  └─────────┘ │
                    │           └────────────────────┬────────────────────┘
                    │                                │
                    │           (On-Prem: PII stays local, tokenized data to cloud)
                    │                                │
                    ▼                                ▼
            ┌──────────────────────────────────────────────────────────┐
            │                   TRAFFIC CONTROL                         │
            │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
            │  │  Sampling   │  │   Rate      │  │ Backpressure│       │
            │  │  Decision   │  │   Limiter   │  │   Check     │       │
            │  └─────────────┘  └─────────────┘  └─────────────┘       │
            └────────────────────────┬─────────────────────────────────┘
                                     │
                                     ▼
            ┌─────────────────────────────────────────────────────────┐
            │                    EDGE FUNCTION                         │
            │  1. Schema validation     5. Calculate frustration       │
            │  2. Enrich geolocation    6. Queue high-frustration      │
            │  3. Device fingerprint    7. Store in database           │
            │  4. Detect rage/dead      8. Trigger Temporal workflow   │
            └────────────────────────┬────────────────────────────────┘
                                     │
                ┌────────────────────┼────────────────────┐
                ▼                    ▼                    ▼
         ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
         │  PostgreSQL │     │   Redis     │     │  Temporal   │
         │  (Events)   │     │  (Queue)    │     │  (Workflow) │
         └─────────────┘     └─────────────┘     └─────────────┘
```

### Live Replay Flow (WebRTC)

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        LIVE REPLAY ARCHITECTURE                           │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   ┌─────────────┐          ┌─────────────┐          ┌─────────────┐      │
│   │   Client    │◀────────▶│   WebRTC    │◀────────▶│   Support   │      │
│   │   Browser   │  P2P     │  Signaling  │  P2P     │   Agent     │      │
│   │  (rrweb)    │  Stream  │   Server    │  Stream  │  Dashboard  │      │
│   └─────────────┘          └─────────────┘          └─────────────┘      │
│         │                        │                        │              │
│         │                        │                        │              │
│         ▼                        ▼                        ▼              │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                    USE CASES                                     │   │
│   │  • Customer Support: Watch user struggle in real-time            │   │
│   │  • Fraud Analysis: Observe suspicious behavior live              │   │
│   │  • QA Testing: Monitor user testing sessions                     │   │
│   │  • High-Frustration Debugging: Immediate intervention            │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│   WebRTC Advantages over WebSocket:                                       │
│   • Ultra-low latency (sub-100ms)                                         │
│   • Peer-to-peer reduces server load                                      │
│   • Built-in NAT traversal (STUN/TURN)                                    │
│   • Secure by default (DTLS encryption)                                   │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

### Temporal Workflow Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    TEMPORAL AI PIPELINE ORCHESTRATION                     │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   ┌─────────────┐                                                         │
│   │  Trigger    │  (High frustration score, error detected, manual)       │
│   └──────┬──────┘                                                         │
│          │                                                                │
│          ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │                  SessionAnalysisWorkflow                         │    │
│   │                                                                  │    │
│   │   Step 1: Fetch Session Data                                     │    │
│   │      ├─ Query PostgreSQL for events                              │    │
│   │      └─ Retry: 3 attempts, exponential backoff                   │    │
│   │                                                                  │    │
│   │   Step 2: AI Summary Generation                                  │    │
│   │      ├─ Route to Gemini Flash via NeuroRouter                    │    │
│   │      ├─ Circuit Breaker: Fallback to GPT-5-mini if Gemini fails  │    │
│   │      └─ Retry: 2 attempts with 10s timeout                       │    │
│   │                                                                  │    │
│   │   Step 3: Root Cause Analysis (parallel)                         │    │
│   │      ├─ Activity 1: Analyze click patterns                       │    │
│   │      ├─ Activity 2: Correlate with backend logs                  │    │
│   │      └─ Activity 3: Check for known issues                       │    │
│   │                                                                  │    │
│   │   Step 4: Generate Fix Suggestions                               │    │
│   │      ├─ Route to GPT-5 for code recommendations                  │    │
│   │      └─ Store results in traceflow_ai_queue                      │    │
│   │                                                                  │    │
│   │   Step 5: Notify & Store                                         │    │
│   │      ├─ Update session with AI insights                          │    │
│   │      ├─ Create UX issue if critical                              │    │
│   │      └─ Send webhook/email notification                          │    │
│   │                                                                  │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│          │                                                                │
│          ▼ (On failure after all retries)                                 │
│   ┌─────────────┐                                                         │
│   │  Dead Letter│────▶ Manual review queue                                │
│   │  Queue      │────▶ Retry workflow (DLQRetryWorkflow)                  │
│   └─────────────┘                                                         │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

### NeuroRouter with Circuit Breaker

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    NEUROROUTER WITH CIRCUIT BREAKER                       │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   ┌─────────────┐                                                         │
│   │  Analysis   │                                                         │
│   │  Request    │                                                         │
│   └──────┬──────┘                                                         │
│          │                                                                │
│          ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │                    TASK TYPE CLASSIFIER                          │    │
│   │  • session_summary     → Gemini Flash (fast + cheap)             │    │
│   │  • root_cause_analysis → Gemini Pro (deep reasoning)             │    │
│   │  • ui_visual_analysis  → Gemini Pro Vision                       │    │
│   │  • code_fix_suggestion → GPT-5 Mini (code expertise)             │    │
│   │  • journey_analysis    → Gemini Flash (balanced)                 │    │
│   └──────────────────────────┬──────────────────────────────────────┘    │
│                              │                                            │
│          ┌───────────────────┼───────────────────┐                       │
│          ▼                   ▼                   ▼                       │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                  │
│   │   Gemini    │    │   OpenAI    │    │   Claude    │                  │
│   │   ┌───────┐ │    │   ┌───────┐ │    │   ┌───────┐ │                  │
│   │   │Circuit│ │    │   │Circuit│ │    │   │Circuit│ │                  │
│   │   │Breaker│ │    │   │Breaker│ │    │   │Breaker│ │                  │
│   │   └───────┘ │    │   └───────┘ │    │   └───────┘ │                  │
│   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                  │
│          │                  │                  │                          │
│          │    ┌─────────────┴──────────────────┤                          │
│          │    │                                │                          │
│          ▼    ▼                                ▼                          │
│   ┌──────────────────────────────────────────────────────────────────┐   │
│   │                    FALLBACK CHAIN                                 │   │
│   │                                                                   │   │
│   │  Primary: Gemini ──[FAIL]──▶ Fallback: OpenAI ──[FAIL]──▶ Claude │   │
│   │                                                                   │   │
│   │  Circuit States per Provider:                                     │   │
│   │  ┌────────┐   ┌────────┐   ┌───────────┐                         │   │
│   │  │ CLOSED │──▶│  OPEN  │──▶│ HALF-OPEN │                         │   │
│   │  │(Normal)│   │(Failed)│   │ (Testing) │                         │   │
│   │  └────────┘   └────────┘   └───────────┘                         │   │
│   │       ▲                          │                                │   │
│   │       └──────────────────────────┘                                │   │
│   │              (Recovery detected)                                  │   │
│   └──────────────────────────────────────────────────────────────────┘   │
│                              │                                            │
│                              ▼                                            │
│                    ┌─────────────┐                                        │
│                    │   Result    │                                        │
│                    │  Aggregator │                                        │
│                    └──────┬──────┘                                        │
│                           │                                               │
│                           ▼                                               │
│                    ┌─────────────┐                                        │
│                    │  Token      │  Track: provider, tokens, latency,     │
│                    │  Metering   │  cost, success/failure                 │
│                    └─────────────┘                                        │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Runner Architecture (Enterprise On-Prem)

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    TRACEFLOW RUNNER (On-Premises)                         │
│              [Deployed in Customer VPC/Data Center]                       │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │                    INGESTION LAYER                               │    │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │
│   │  │   HTTPS     │  │  WebSocket  │  │   WebRTC    │              │    │
│   │  │  Ingest     │  │   Ingest    │  │  Signaling  │              │    │
│   │  │  (Go/Node)  │  │  (Go/Node)  │  │   Server    │              │    │
│   │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │    │
│   │         │                │                │                      │    │
│   │         └────────────────┼────────────────┘                      │    │
│   │                          ▼                                       │    │
│   └──────────────────────────┼───────────────────────────────────────┘    │
│                              │                                            │
│   ┌──────────────────────────▼───────────────────────────────────────┐    │
│   │                  TOKENIZATION ENGINE                              │    │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │
│   │  │   PII       │  │   Pattern   │  │   Token     │              │    │
│   │  │  Detector   │  │   Matcher   │  │   Vault     │              │    │
│   │  │ (ML-based)  │  │  (Regex)    │  │  (Local)    │              │    │
│   │  └─────────────┘  └─────────────┘  └─────────────┘              │    │
│   │                                                                  │    │
│   │  PII Types Detected & Masked:                                    │    │
│   │  • Email addresses    • Phone numbers    • Credit cards          │    │
│   │  • SSN/Tax IDs        • Names            • Addresses             │    │
│   │  • IP addresses       • Custom patterns  • Sensitive fields      │    │
│   └──────────────────────────┬───────────────────────────────────────┘    │
│                              │                                            │
│   ┌──────────────────────────▼───────────────────────────────────────┐    │
│   │                    LOCAL REDIS STREAMS                            │    │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │
│   │  │  Event      │  │  Pending    │  │   DLQ       │              │    │
│   │  │  Buffer     │  │  Upload     │  │  (Failed)   │              │    │
│   │  └─────────────┘  └─────────────┘  └─────────────┘              │    │
│   │                                                                  │    │
│   │  Offline Mode: Events buffered locally when cloud unreachable    │    │
│   │  Auto-sync: Resume upload when connectivity restored             │    │
│   └──────────────────────────┬───────────────────────────────────────┘    │
│                              │                                            │
│   ┌──────────────────────────▼───────────────────────────────────────┐    │
│   │                    LOCAL WORKERS                                  │    │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │
│   │  │ Compression │  │  Chunking   │  │  Pre-       │              │    │
│   │  │  (LZ4/Zstd) │  │  Service    │  │  Processing │              │    │
│   │  └─────────────┘  └─────────────┘  └─────────────┘              │    │
│   └──────────────────────────┬───────────────────────────────────────┘    │
│                              │                                            │
│   ┌──────────────────────────▼───────────────────────────────────────┐    │
│   │                  CLOUD UPLOADER (mTLS)                            │    │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │
│   │  │  Batch      │  │  Retry      │  │  Backpressure│              │    │
│   │  │  Uploader   │  │  Handler    │  │  Monitor    │              │    │
│   │  └─────────────┘  └─────────────┘  └─────────────┘              │    │
│   │                                                                  │    │
│   │  Security: mTLS with rotating certificates                       │    │
│   │  Bandwidth: Adaptive based on network conditions                 │    │
│   └──────────────────────────────────────────────────────────────────┘    │
│                              │                                            │
└──────────────────────────────┼────────────────────────────────────────────┘
                               │
                               ▼ (Tokenized data only)
                    ┌─────────────────────┐
                    │  TRACEFLOW CLOUD    │
                    │  (Control Plane)    │
                    └─────────────────────┘
```

---

## Policy Sync Architecture

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    POLICY SYNC (Cloud → Runner)                           │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │                    CLOUD CONTROL PLANE                           │    │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │
│   │  │  Feature    │  │  Retention  │  │  Sampling   │              │    │
│   │  │  Flags      │  │  Policies   │  │  Rules      │              │    │
│   │  └─────────────┘  └─────────────┘  └─────────────┘              │    │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │
│   │  │  Rate       │  │  PII        │  │  Compliance │              │    │
│   │  │  Limits     │  │  Patterns   │  │  Settings   │              │    │
│   │  └─────────────┘  └─────────────┘  └─────────────┘              │    │
│   └──────────────────────────┬──────────────────────────────────────┘    │
│                              │                                            │
│                              │ Push (Webhook) / Pull (Polling)            │
│                              │                                            │
│   ┌──────────────────────────▼──────────────────────────────────────┐    │
│   │                    RUNNER POLICY ENGINE                          │    │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │
│   │  │  Policy     │  │  Version    │  │  Rollback   │              │    │
│   │  │  Cache      │  │  Manager    │  │  Handler    │              │    │
│   │  └─────────────┘  └─────────────┘  └─────────────┘              │    │
│   │                                                                  │    │
│   │  Sync Frequency: Every 60s (configurable)                        │    │
│   │  Fallback: Use last-known-good policy if cloud unreachable       │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
│   Policy Types Synced:                                                    │
│   • feature_flags: Enable/disable features per tenant                     │
│   • retention_days: How long to keep data locally                         │
│   • sampling_rate: Percentage of sessions to capture                      │
│   • pii_patterns: Custom PII detection patterns                           │
│   • rate_limits: Max events per second per project                        │
│   • compliance: GDPR, HIPAA, SOC2 settings                                │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Deployment Modes

### Mode 1: Full SaaS (Lovable Cloud)

```
┌────────────────────────────────────────────────────────────────┐
│                    SAAS DEPLOYMENT                              │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                      CDN (Global Edge)                   │  │
│   └─────────────────────────────────────────────────────────┘  │
│                           │                                     │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │              SUPABASE / LOVABLE CLOUD                    │  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │  │
│   │  │  Edge Func  │  │  Database   │  │  Realtime   │      │  │
│   │  └─────────────┘  └─────────────┘  └─────────────┘      │  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │  │
│   │  │  Auth       │  │  Storage    │  │  pgvector   │      │  │
│   │  └─────────────┘  └─────────────┘  └─────────────┘      │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│   Best For: Startups, SMBs, rapid prototyping                  │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

### Mode 2: Hybrid (Runner On-Prem + Cloud Control Plane)

```
┌────────────────────────────────────────────────────────────────┐
│                    HYBRID DEPLOYMENT                            │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │              CUSTOMER VPC / DATA CENTER                  │  │
│   │  ┌───────────────────────────────────────────────────┐  │  │
│   │  │                 TRACEFLOW RUNNER                   │  │  │
│   │  │  • Ingest Server (Go/Node)                         │  │  │
│   │  │  • Tokenization Engine (PII never leaves)          │  │  │
│   │  │  • Local Redis Streams                             │  │  │
│   │  │  • Local Workers (compression, preprocessing)      │  │  │
│   │  └───────────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────────┘  │
│                           │                                     │
│                           │ mTLS (Tokenized data only)          │
│                           ▼                                     │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │              TRACEFLOW CLOUD (Control Plane)             │  │
│   │  • AI Processing (NeuroRouter)                           │  │
│   │  • Dashboard & Analytics                                 │  │
│   │  • Policy Management                                     │  │
│   │  • Billing & Metering                                    │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│   Best For: BFSI, Insurance, Healthcare, Government            │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

### Mode 3: Fully On-Premises

```
┌────────────────────────────────────────────────────────────────┐
│                    ON-PREMISES DEPLOYMENT                       │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │              KUBERNETES CLUSTER                          │  │
│   │  ┌───────────────────────────────────────────────────┐  │  │
│   │  │                 INGRESS (NGINX)                    │  │  │
│   │  └───────────────────────────────────────────────────┘  │  │
│   │      ┌───────────────────┬───────────────────┐          │  │
│   │      ▼                   ▼                   ▼          │  │
│   │  ┌─────────┐       ┌─────────┐       ┌─────────┐        │  │
│   │  │  Web    │       │   API   │       │ Runner  │        │  │
│   │  │  App    │       │ Gateway │       │  Pods   │        │  │
│   │  └─────────┘       └─────────┘       └─────────┘        │  │
│   │                          │                               │  │
│   │      ┌───────────────────┼───────────────────┐          │  │
│   │      ▼                   ▼                   ▼          │  │
│   │  ┌─────────┐       ┌─────────┐       ┌─────────┐        │  │
│   │  │Postgres │       │  Redis  │       │  MinIO  │        │  │
│   │  │ (HA)    │       │ Cluster │       │  (S3)   │        │  │
│   │  └─────────┘       └─────────┘       └─────────┘        │  │
│   │                          │                               │  │
│   │      ┌───────────────────┼───────────────────┐          │  │
│   │      ▼                   ▼                   ▼          │  │
│   │  ┌─────────┐       ┌─────────┐       ┌─────────┐        │  │
│   │  │Temporal │       │  AI     │       │ Vector  │        │  │
│   │  │ Cluster │       │ Workers │       │  DB     │        │  │
│   │  └─────────┘       └─────────┘       └─────────┘        │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│   Best For: Government, Military, Air-gapped environments      │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

### Mode 4: Air-Gapped (No External Connectivity)

```
┌────────────────────────────────────────────────────────────────┐
│                    AIR-GAPPED DEPLOYMENT                        │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │              ISOLATED NETWORK                            │  │
│   │                                                          │  │
│   │  Full TRACEFLOW stack deployed locally:                  │  │
│   │  • All services containerized                            │  │
│   │  • Local LLM (Ollama/vLLM) for AI processing             │  │
│   │  • No external API calls                                 │  │
│   │  • Manual updates via secure media                       │  │
│   │                                                          │  │
│   │  ┌─────────────────────────────────────────────────┐    │  │
│   │  │  LOCAL LLM OPTIONS                               │    │  │
│   │  │  • Ollama (Llama 3, Mistral, CodeLlama)          │    │  │
│   │  │  • vLLM for high-throughput                      │    │  │
│   │  │  • TensorRT-LLM for NVIDIA GPUs                  │    │  │
│   │  └─────────────────────────────────────────────────┘    │  │
│   │                                                          │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│   Best For: Defense, High-security banking, Critical infra     │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

## Security Architecture

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         SECURITY LAYERS                                   │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   Layer 1: Transport Security                                             │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  • mTLS everywhere (Runner ↔ Cloud)                              │    │
│   │  • Certificate rotation (automated)                              │    │
│   │  • TLS 1.3 minimum                                               │    │
│   │  • Perfect forward secrecy                                       │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
│   Layer 2: Data Protection                                                │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  • PII tokenization at Runner (never leaves enterprise)         │    │
│   │  • Encryption at rest (AES-256)                                  │    │
│   │  • Field-level encryption for sensitive data                     │    │
│   │  • Secure key management (Vault/KMS)                             │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
│   Layer 3: Access Control                                                 │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  • RBAC with fine-grained permissions                            │    │
│   │  • SSO (SAML, OAuth2, OIDC)                                      │    │
│   │  • MFA enforcement                                               │    │
│   │  • API key scoping and rotation                                  │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
│   Layer 4: Audit & Compliance                                             │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  • Complete audit trail (who, what, when)                        │    │
│   │  • GDPR data subject requests                                    │    │
│   │  • HIPAA compliance mode                                         │    │
│   │  • SOC2 Type II ready                                            │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Scalability Patterns

### Horizontal Scaling

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    HORIZONTAL SCALING ARCHITECTURE                        │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │                    LOAD BALANCER                                 │    │
│   └──────────────────────────┬──────────────────────────────────────┘    │
│                              │                                            │
│          ┌───────────────────┼───────────────────┐                       │
│          ▼                   ▼                   ▼                       │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                  │
│   │  API Pod 1  │    │  API Pod 2  │    │  API Pod N  │                  │
│   │  (Stateless)│    │  (Stateless)│    │  (Stateless)│                  │
│   └─────────────┘    └─────────────┘    └─────────────┘                  │
│          │                   │                   │                       │
│          └───────────────────┼───────────────────┘                       │
│                              ▼                                            │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │                    REDIS CLUSTER                                 │    │
│   │  (Sharded across 3+ nodes for high availability)                 │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                              │                                            │
│          ┌───────────────────┼───────────────────┐                       │
│          ▼                   ▼                   ▼                       │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                  │
│   │  Worker 1   │    │  Worker 2   │    │  Worker N   │                  │
│   │  (BullMQ)   │    │  (BullMQ)   │    │  (BullMQ)   │                  │
│   └─────────────┘    └─────────────┘    └─────────────┘                  │
│                                                                           │
│   Auto-scaling triggers:                                                  │
│   • CPU > 70% for 5 minutes                                              │
│   • Memory > 80%                                                         │
│   • Queue depth > 10,000 events                                          │
│   • Response latency > 500ms p95                                         │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

### Data Partitioning Strategy

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    DATA PARTITIONING                                      │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   PostgreSQL Partitioning:                                                │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  traceflow_events                                                │    │
│   │  ├── traceflow_events_2025_01  (January 2025)                    │    │
│   │  ├── traceflow_events_2025_02  (February 2025)                   │    │
│   │  ├── traceflow_events_2025_03  (March 2025)                      │    │
│   │  └── ... (Monthly partitions)                                    │    │
│   │                                                                  │    │
│   │  Benefits:                                                       │    │
│   │  • Fast queries on recent data                                   │    │
│   │  • Easy archival (drop old partitions)                           │    │
│   │  • Parallel query execution                                      │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
│   Tenant Isolation:                                                       │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  • Row-level security (RLS) for multi-tenancy                    │    │
│   │  • Tenant ID in every query                                      │    │
│   │  • Connection pooling per tenant (PgBouncer)                     │    │
│   │  • Dedicated schemas for large enterprise tenants                │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Performance Benchmarks

| Component | Target | Measurement |
|-----------|--------|-------------|
| Event Ingestion | < 50ms p99 | Time from SDK to queue |
| Session Replay Load | < 2s | Time to first frame |
| AI Analysis (Summary) | < 5s | End-to-end latency |
| Dashboard Load | < 1s | Time to interactive |
| Live Replay Latency | < 100ms | WebRTC round-trip |
| API Response | < 100ms p95 | REST endpoint latency |

---

## Disaster Recovery

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    DISASTER RECOVERY                                      │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   RPO (Recovery Point Objective): 1 hour                                  │
│   RTO (Recovery Time Objective): 4 hours                                  │
│                                                                           │
│   Backup Strategy:                                                        │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  • PostgreSQL: Continuous WAL archiving to S3                    │    │
│   │  • Redis: RDB snapshots every 15 minutes                         │    │
│   │  • Object Storage: Cross-region replication                      │    │
│   │  • Temporal: Workflow history backed up hourly                   │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
│   Failover:                                                               │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  • Primary Region: us-east-1                                     │    │
│   │  • DR Region: eu-west-1                                          │    │
│   │  • DNS failover: < 5 minutes                                     │    │
│   │  • Database failover: Read replicas promoted                     │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Summary: Enterprise-Grade Components

| Component | Status | Description |
|-----------|--------|-------------|
| **Runner Layer** | ✅ Added | On-prem ingest with PII tokenization |
| **Temporal Workflows** | ✅ Added | Durable AI orchestration with retry/DLQ |
| **WebRTC Live Replay** | ✅ Added | Ultra-low latency live session viewing |
| **Traffic Control** | ✅ Added | Adaptive sampling, rate limiting, backpressure |
| **Circuit Breakers** | ✅ Added | LLM provider failover handling |
| **Billing & Metering** | ✅ Added | Token tracking, usage quotas |
| **Policy Sync** | ✅ Added | Cloud → Runner configuration sync |
| **Air-Gapped Mode** | ✅ Added | Fully isolated deployment option |

---

*This architecture is designed to be globally competitive with Glassbox, FullStory, and Contentsquare while offering unique AI-native capabilities and enterprise deployment flexibility.*
