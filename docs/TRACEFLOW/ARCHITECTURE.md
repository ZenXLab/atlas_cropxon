# TRACEFLOW System Architecture

> **Last Updated:** 2025-12-10  
> **Version:** 1.0.0-beta

## High-Level Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                     │
├──────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Web SDK    │  │  Mobile SDK  │  │  Backend SDK │  │   REST API   │      │
│  │  (rrweb +    │  │  (RN/Flutter)│  │  (Node/Py)   │  │   Clients    │      │
│  │  Custom)     │  │              │  │              │  │              │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         │                 │                 │                 │              │
│         └─────────────────┼─────────────────┼─────────────────┘              │
│                           ▼                                                   │
└──────────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                            INGESTION LAYER                                    │
├──────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        API GATEWAY (Edge Functions)                      │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │ │
│  │  │  WebSocket  │  │    REST     │  │   Batch     │  │    Webhook  │     │ │
│  │  │  Handler    │  │  Endpoint   │  │   Upload    │  │   Receiver  │     │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                           │                                                   │
│                           ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                      EVENT VALIDATION & ENRICHMENT                       │ │
│  │  • Schema validation (Zod)                                               │ │
│  │  • IP geolocation lookup                                                 │ │
│  │  • Device fingerprinting                                                 │ │
│  │  • Session association                                                   │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                           PROCESSING LAYER                                    │
├──────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                         STREAM PROCESSOR                                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │ │
│  │  │   Event     │  │  Rage Click │  │   Dead      │  │  Frustration│     │ │
│  │  │   Router    │  │  Detector   │  │   Click     │  │  Calculator │     │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                           │                                                   │
│                           ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                      AI PROCESSING QUEUE                                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                      │ │
│  │  │   Priority  │  │   Task      │  │   Result    │                      │ │
│  │  │   Queue     │  │   Executor  │  │   Handler   │                      │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                      │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                            STORAGE LAYER                                      │
├──────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐           │
│  │    PostgreSQL    │  │      Redis       │  │  Object Storage  │           │
│  │                  │  │                  │  │                  │           │
│  │  • Sessions      │  │  • Session cache │  │  • Recordings    │           │
│  │  • Events        │  │  • Rate limiting │  │  • Screenshots   │           │
│  │  • UX Issues     │  │  • Realtime pub  │  │  • Exports       │           │
│  │  • Analytics     │  │  • Job queues    │  │  • Backups       │           │
│  │  • User data     │  │                  │  │                  │           │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘           │
└──────────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                         INTELLIGENCE LAYER                                    │
├──────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                          NEUROROUTER                                     │ │
│  │                    (Multi-LLM Task Router)                               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │ │
│  │  │   Gemini    │  │   OpenAI    │  │   Claude    │  │  DeepSeek   │     │ │
│  │  │   (Vision)  │  │   (Code)    │  │  (Reason)   │  │  (Economy)  │     │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                           │                                                   │
│                           ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                       ANALYSIS ENGINES                                   │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │ │
│  │  │   Session   │  │  Journey    │  │  Conversion │  │   Anomaly   │     │ │
│  │  │   Analyzer  │  │   Mapper    │  │   Funnel    │  │   Detector  │     │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                          PRESENTATION LAYER                                   │
├──────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐           │
│  │    Dashboard     │  │    REST API      │  │    Webhooks      │           │
│  │    (React SPA)   │  │    (External)    │  │    (Outbound)    │           │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘           │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow Architecture

### Event Capture Flow

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│  User   │────▶│   SDK   │────▶│  Edge   │────▶│  Queue  │────▶│   DB    │
│ Action  │     │ Capture │     │Function │     │(Redis)  │     │(Postgres│
└─────────┘     └─────────┘     └─────────┘     └─────────┘     └─────────┘
                    │                               │
                    │                               ▼
                    │                         ┌─────────┐
                    │                         │   AI    │
                    └────────────────────────▶│Analysis │
                      (High frustration       └─────────┘
                       triggers immediate
                       AI analysis)
```

### Session Recording Flow

```
┌──────────────────────────────────────────────────────────────┐
│                      CLIENT BROWSER                           │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                    rrweb Recorder                        │ │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐     │ │
│  │  │   DOM   │  │  Mouse  │  │ Network │  │ Console │     │ │
│  │  │ Snapshot│  │  Track  │  │ Monitor │  │  Logs   │     │ │
│  │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘     │ │
│  │       │            │            │            │           │ │
│  │       └────────────┼────────────┼────────────┘           │ │
│  │                    ▼                                     │ │
│  │            ┌───────────────┐                             │ │
│  │            │ Event Buffer  │                             │ │
│  │            │ (Compression) │                             │ │
│  │            └───────┬───────┘                             │ │
│  └────────────────────┼─────────────────────────────────────┘ │
└───────────────────────┼──────────────────────────────────────┘
                        │
                        ▼ (Batch every 5s or on page unload)
┌──────────────────────────────────────────────────────────────┐
│                    EDGE FUNCTION                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                 traceflow-capture                        │ │
│  │  1. Decompress events                                    │ │
│  │  2. Validate schema                                      │ │
│  │  3. Enrich with geolocation                              │ │
│  │  4. Detect rage/dead clicks                              │ │
│  │  5. Calculate frustration score                          │ │
│  │  6. Queue high-frustration for AI                        │ │
│  │  7. Store in database                                    │ │
│  └─────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌──────────────────────────────────────────────────────────────┐
│                    DATABASE                                   │
│  ┌─────────────────┐  ┌─────────────────┐                    │
│  │ traceflow_      │  │ session_        │                    │
│  │ sessions        │  │ recordings      │                    │
│  │                 │  │                 │                    │
│  │ • session_id    │  │ • events (JSONB)│                    │
│  │ • visitor_id    │  │ • duration_ms   │                    │
│  │ • device_info   │  │ • page_count    │                    │
│  │ • frustration   │  │ • compressed    │                    │
│  └─────────────────┘  └─────────────────┘                    │
└──────────────────────────────────────────────────────────────┘
```

### AI Analysis Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    NEUROROUTER PIPELINE                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌─────────────┐                                               │
│   │  Analysis   │                                               │
│   │  Request    │                                               │
│   └──────┬──────┘                                               │
│          │                                                       │
│          ▼                                                       │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │              TASK TYPE CLASSIFIER                        │   │
│   │                                                          │   │
│   │  • session_summary     → Gemini Flash (fast + cheap)     │   │
│   │  • root_cause_analysis → Gemini Pro (deep reasoning)     │   │
│   │  • ui_visual_analysis  → Gemini Pro (vision)             │   │
│   │  • code_fix_suggestion → GPT-5 Mini (code expertise)     │   │
│   │  • journey_analysis    → Gemini Flash (balanced)         │   │
│   └──────────────────────────┬──────────────────────────────┘   │
│                              │                                   │
│          ┌───────────────────┼───────────────────┐              │
│          ▼                   ▼                   ▼              │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│   │   Gemini    │    │   OpenAI    │    │   Claude    │        │
│   │   Flash     │    │   GPT-5     │    │   Claude-4  │        │
│   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘        │
│          │                  │                  │                │
│          └──────────────────┼──────────────────┘                │
│                             ▼                                    │
│                    ┌─────────────┐                              │
│                    │   Result    │                              │
│                    │  Aggregator │                              │
│                    └──────┬──────┘                              │
│                           │                                      │
│                           ▼                                      │
│                    ┌─────────────┐                              │
│                    │   Store &   │                              │
│                    │   Notify    │                              │
│                    └─────────────┘                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## Database Schema Overview

```
┌────────────────────────────────────────────────────────────────────────────┐
│                         TRACEFLOW DATABASE SCHEMA                           │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────┐       ┌─────────────────────┐                     │
│  │  traceflow_projects │       │ traceflow_api_keys  │                     │
│  │  ──────────────────│◀──────│ ─────────────────── │                     │
│  │  id (PK)           │       │ id (PK)             │                     │
│  │  name              │       │ project_id (FK)     │                     │
│  │  created_at        │       │ key_hash            │                     │
│  │  settings          │       │ last_used_at        │                     │
│  └──────────┬──────────┘       └─────────────────────┘                     │
│             │                                                               │
│             │ 1:N                                                           │
│             ▼                                                               │
│  ┌─────────────────────┐       ┌─────────────────────┐                     │
│  │ traceflow_sessions  │       │   traceflow_events  │                     │
│  │  ──────────────────│◀──────│ ─────────────────── │                     │
│  │  id (PK)           │ 1:N   │ id (PK)             │                     │
│  │  session_id        │       │ session_id (FK)     │                     │
│  │  project_id (FK)   │       │ event_type          │                     │
│  │  visitor_id        │       │ event_data (JSONB)  │                     │
│  │  device_info       │       │ timestamp           │                     │
│  │  frustration_score │       │ page_url            │                     │
│  │  started_at        │       └─────────────────────┘                     │
│  │  ended_at          │                                                    │
│  └──────────┬──────────┘                                                   │
│             │                                                               │
│             │ 1:N                                                           │
│             ▼                                                               │
│  ┌─────────────────────┐       ┌─────────────────────┐                     │
│  │ session_recordings  │       │ traceflow_ux_issues │                     │
│  │  ──────────────────│       │ ─────────────────── │                     │
│  │  id (PK)           │       │ id (PK)             │                     │
│  │  session_id (FK)   │       │ session_id (FK)     │                     │
│  │  events (JSONB)    │       │ issue_type          │                     │
│  │  duration_ms       │       │ severity            │                     │
│  │  page_count        │       │ component           │                     │
│  │  geolocation       │       │ ai_recommendation   │                     │
│  └─────────────────────┘       │ status              │                     │
│                                └─────────────────────┘                     │
│                                                                             │
│  ┌─────────────────────┐       ┌─────────────────────┐                     │
│  │ traceflow_ai_queue  │       │ neurorouter_logs    │                     │
│  │  ──────────────────│       │ ─────────────────── │                     │
│  │  id (PK)           │       │ id (PK)             │                     │
│  │  session_id (FK)   │       │ task_type           │                     │
│  │  task_type         │       │ model_used          │                     │
│  │  priority          │       │ latency_ms          │                     │
│  │  status            │       │ tokens_used         │                     │
│  │  created_at        │       │ cost_estimate       │                     │
│  └─────────────────────┘       └─────────────────────┘                     │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## Deployment Architecture

### Cloud Deployment (Lovable Cloud / Supabase)

```
┌────────────────────────────────────────────────────────────────┐
│                    LOVABLE CLOUD                                │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                      CDN                                 │  │
│   │                 (Global Edge)                            │  │
│   └─────────────────────────────────────────────────────────┘  │
│                           │                                     │
│                           ▼                                     │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │              SUPABASE PLATFORM                           │  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │  │
│   │  │  Edge       │  │  Database   │  │  Realtime   │      │  │
│   │  │  Functions  │  │  (Postgres) │  │  (WebSocket)│      │  │
│   │  └─────────────┘  └─────────────┘  └─────────────┘      │  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │  │
│   │  │  Auth       │  │  Storage    │  │  Vectors    │      │  │
│   │  │  (JWT)      │  │  (S3-like)  │  │  (pgvector) │      │  │
│   │  └─────────────┘  └─────────────┘  └─────────────┘      │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

### Self-Hosted / On-Premises

```
┌────────────────────────────────────────────────────────────────┐
│                  ON-PREMISES DEPLOYMENT                         │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │              KUBERNETES CLUSTER                          │  │
│   │  ┌───────────────────────────────────────────────────┐  │  │
│   │  │                 INGRESS (NGINX)                    │  │  │
│   │  └───────────────────────────────────────────────────┘  │  │
│   │                          │                               │  │
│   │      ┌───────────────────┼───────────────────┐          │  │
│   │      ▼                   ▼                   ▼          │  │
│   │  ┌─────────┐       ┌─────────┐       ┌─────────┐        │  │
│   │  │  Web    │       │   API   │       │ Worker  │        │  │
│   │  │  App    │       │ Gateway │       │  Pods   │        │  │
│   │  │ (React) │       │  (Deno) │       │         │        │  │
│   │  └─────────┘       └─────────┘       └─────────┘        │  │
│   │                          │                               │  │
│   │      ┌───────────────────┼───────────────────┐          │  │
│   │      ▼                   ▼                   ▼          │  │
│   │  ┌─────────┐       ┌─────────┐       ┌─────────┐        │  │
│   │  │Postgres │       │  Redis  │       │  MinIO  │        │  │
│   │  │ (HA)    │       │ Cluster │       │  (S3)   │        │  │
│   │  └─────────┘       └─────────┘       └─────────┘        │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

## Security Architecture

```
┌────────────────────────────────────────────────────────────────┐
│                    SECURITY LAYERS                              │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Layer 1: NETWORK SECURITY                                     │
│   ├── TLS 1.3 encryption in transit                            │
│   ├── DDoS protection (Cloudflare/AWS Shield)                  │
│   ├── WAF (Web Application Firewall)                           │
│   └── Rate limiting per API key                                │
│                                                                 │
│   Layer 2: APPLICATION SECURITY                                 │
│   ├── JWT token authentication                                  │
│   ├── OAuth 2.0 / SAML SSO                                     │
│   ├── API key management                                        │
│   └── Input validation (Zod schemas)                           │
│                                                                 │
│   Layer 3: DATA SECURITY                                        │
│   ├── AES-256 encryption at rest                               │
│   ├── Row-Level Security (RLS) policies                        │
│   ├── PII masking in session recordings                        │
│   └── Data retention policies                                   │
│                                                                 │
│   Layer 4: COMPLIANCE                                           │
│   ├── GDPR data subject rights                                 │
│   ├── SOC 2 Type II controls                                   │
│   ├── HIPAA BAA (healthcare customers)                         │
│   └── Audit logging                                             │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

## Scalability Considerations

### Horizontal Scaling Points

| Component | Scaling Strategy |
|-----------|------------------|
| Edge Functions | Auto-scale based on request volume |
| Database | Read replicas for query distribution |
| Redis | Cluster mode for distributed caching |
| Storage | CDN for static assets, S3 for recordings |
| AI Processing | Queue-based with priority scheduling |

### Performance Targets

| Metric | Target | Current |
|--------|--------|---------|
| Event ingestion latency | < 50ms | ~40ms |
| Session replay load time | < 2s | ~1.5s |
| AI analysis response | < 5s | ~3s |
| Dashboard page load | < 1s | ~800ms |
| API response time (p95) | < 200ms | ~150ms |
